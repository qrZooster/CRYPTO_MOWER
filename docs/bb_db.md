# ๐งญ bb_db.md โ ะััะธัะตะบัััะฐ ัะธััะตะผั QR()

**ะะตััะธั:** QR (2025-10-07)  
**ะคะฐะนะป:** `bb_db.py`  
**ะะฐะทะฝะฐัะตะฝะธะต:** ะฆะตะฝััะฐะปัะฝัะน ะผะพะดัะปั ะฑะฐะทั ะดะฐะฝะฝัั Tradition QR Framework  
**ะะฒัะพัััะฒะพ:** Canonical Build System (Tradition-2025)

---

## ๐ ะะฑัะธะน ะพะฑะทะพั

`bb_db.py` โ ัะดัะพ ะฟะพะดัะธััะตะผั ะดะฐะฝะฝัั QR-ะฐััะธัะตะบัััั.  
ะะฝ ะพะฑัะตะดะธะฝัะตั ัะฟัะฐะฒะปะตะฝะธะต ัะพะตะดะธะฝะตะฝะธัะผะธ, CRUD-ะพะฟะตัะฐัะธะธ, ะบะพะฝัะธะณััะฐัะธั ะพะบััะถะตะฝะธั ะธ introspection ััะตะผั ะฒ ะตะดะธะฝัะน ัะฝะธัะธัะธัะพะฒะฐะฝะฝัะน ะผะพะดัะปั.

ะัะฝะพะฒะฝัะต ะบะพะผะฟะพะฝะตะฝัั ะพะฑัะฐะทััั ยซัะตัััะต ะทะฐัะฒะพัะฐยป:

> **Session โ Database โ Config โ Schema**

ะัะต ัะฟัะฐะฒะปััััั ัะตัะตะท ะพะฑัะตะบั `TApplication`, ะบะพัะพััะน ัะพะทะดะฐัั ะธ ัะฒัะทัะฒะฐะตั ััะธ ะบะพะผะฟะพะฝะตะฝัั ะฒ ะตะดะธะฝัั ัะธััะตะผั.

---

## โ๏ธ ะััะธัะตะบัััะฝัะต ัะพะปะธ ะบะพะผะฟะพะฝะตะฝัะพะฒ

| ะะพะผะฟะพะฝะตะฝั | ะะปะฐัั | ะะฐะทะฝะฐัะตะฝะธะต |
|------------|-------|------------|
| **Session** | `TSession` | ะฃะฟัะฐะฒะปะตะฝะธะต ะฟัะปะพะผ ัะพะตะดะธะฝะตะฝะธะน MySQL ะธ keep-alive |
| **Database** | `TDatabase` | ะฃะฝะธะฒะตััะฐะปัะฝัะน SQL-ะธะฝัะตััะตะนั ะธ QR API |
| **Config** | `TConfig` | ะฃะฟัะฐะฒะปะตะฝะธะต ะฟะฐัะฐะผะตััะฐะผะธ ะพะบััะถะตะฝะธั ะธ ัะฐะฑะปะธัะตะน `ZZ$CONFIG` |
| **Schema** | `TSchema` | Introspection ััััะบัััั ะะ, ัะธะปัััั, ะดะพะบััะธะฝะฝะฐั ะปะพะณะธะบะฐ |
| **Application** | `TApplication` | ะะพะฝัะตะนะฝะตั ะธ ัะพัะบะฐ ะธะฝะธัะธะฐะปะธะทะฐัะธะธ ะบะพะผะฟะพะฝะตะฝัะพะฒ |
| **Facade API** | `qr_*`, `exec`, `key_*`, `mk_*` | ะฃะฟัะพััะฝะฝัะน ะธะฝัะตััะตะนั ะบ ะฑะฐะทะต ะธ ะบะพะฝัะธะณััะฐัะธะธ |

---

## ๐งฉ Canonical constants

ะะดะธะฝัะน ะฝะฐะฑะพั ะธะผัะฝ ะฟะพะปะตะน, ะฟัะธะฝัััะน ะฒะพ ะฒัะตั ัะฐะฑะปะธัะฐั ะธ ัะธััะตะผะฝัั ััััะบัััะฐั:

```
FLD_ID, FLD_HASH, FLD_TCOD, FLD_SYMBOL,
FLD_TYPE, FLD_NAME, FLD_TEXT,
FLD_DATE, FLD_DATE_TIME,
FLD_PRICE, FLD_VOLUME, FLD_SUM, FLD_VALUE,
FLD_SOURCE, FLD_URL, FLD_TITLE, FLD_TAGS, FLD_VERSION
```

---

## ๐ง ะัะตะผะตะฝะฝัะต ัะตะปะฟะตัั

### `_to_dt_msk(ts)`
ะัะธะฒะพะดะธั ะฒัะตะผั `ts` (ะฒ ัะตะบัะฝะดะฐั, ะผะธะปะปะธัะตะบัะฝะดะฐั ะธะปะธ `datetime`) ะบ timezone-aware `datetime` ะฒ ะะกะ.  
ะัะฟะพะปัะทัะตััั ะดะปั ัะฝะธัะธะบะฐัะธะธ ะฒัะตะผะตะฝะฝัั ะผะตัะพะบ ะธ TCOD-ะณะตะฝะตัะฐัะธะธ.

### `mk_tcod(symbol, ts, tf, venue)`
ะกะพะทะดะฐัั ัะฝะธะฒะตััะฐะปัะฝัะน ะฒัะตะผะตะฝะฝะพะน ะบะพะด:
```
SYMBOL_YYYYMMDD_HHMMSS[_mmm]_TF_VENUE
```
ะัะธะผะตั:  
`AIAUSDT_20250929_061600_1SEC_BYBIT`

---

## ๐ฉ ะะปะฐัั `TSession` โ ะผะตะฝะตะดะถะตั ัะพะตะดะธะฝะตะฝะธะน

**ะะพะปั:** ัะฟัะฐะฒะปัะตั ะฟัะปะพะผ MySQL ัะพะตะดะธะฝะตะฝะธะน ะธ ะฟะพะดะดะตัะถะธะฒะฐะตั ะธั ะฐะบัะธะฒะฝะพััั.

### ะัะฝะพะฒะฝัะต ะผะตัะพะดั:
- `do_open(pool_size=8)` โ ัะพะทะดะฐัั ะฟัะป ัะพะตะดะธะฝะตะฝะธะน.  
- `do_close()` โ ะทะฐะฒะตััะฐะตั ะฟัะป ะธ keep-alive.  
- `_get_connection()` โ ะฒัะดะฐัั ัะพะตะดะธะฝะตะฝะธะต ะธะท ะฟัะปะฐ.  
- `exec(sql, params)` โ ะฒัะฟะพะปะฝัะตั ะทะฐะฟัะพั ะฑะตะท ะฒัะฑะพัะบะธ.  
- `_exec_cursor()` โ ัะฝะธะฒะตััะฐะปัะฝัะน cursor-executor ั ะฑะตะทะพะฟะฐัะฝัะผ ะทะฐะบัััะธะตะผ.  
- `keep_alive(interval)` โ ะทะฐะฟััะบะฐะตั ะฟะพัะพะบ-ะฟะธะฝะณ ัะพะตะดะธะฝะตะฝะธะน.  
- `stop_keep_alive()` โ ะทะฐะฒะตััะฐะตั keep-alive ัะธะบะป.

**ะัะพะฑะตะฝะฝะพััั:** keep-alive ะพะฑะตัะฟะตัะธะฒะฐะตั ะฟะพััะพัะฝะฝะพะต ัะพะตะดะธะฝะตะฝะธะต ั MySQL ะดะฐะถะต ะฟัะธ ะดะพะปะณะธั ะฟัะพััะพัั.

---

## ๐งฑ ะะปะฐัั `TDatabase` โ SQL-ัะฐัะฐะด ะธ QR-API

ะัะฝะพะฒะฝะพะน ะธะฝัะตััะตะนั ะดะปั ะฒัะตั SQL-ะพะฟะตัะฐัะธะน ะธ ะปะพะณะธะบะธ CRUD.

### ะัะฝะพะฒะฝัะต ะผะตัะพะดั
| ะะตัะพะด | ะะฐะทะฝะฐัะตะฝะธะต |
|--------|-------------|
| `do_open()` | ะัะพะฒะตัะบะฐ ัะพะตะดะธะฝะตะฝะธั (`SELECT 1`) ะธ ะฐะบัะธะฒะฐัะธั Session |
| `do_close()` | ะะฐะบัััะธะต ัะพะตะดะธะฝะตะฝะธะน |
| `_exec_cursor()` | ะัะฟะพะปะฝะตะฝะธะต SQL ะธ ะฒะพะทะฒัะฐั ะดะฐะฝะฝัั |
| `_exec_cursor_dict()` | ะขะพ ะถะต, ะฝะพ ั `dictionary=True` |
| `_where_sql()` | ะะพัััะพะตะฝะธะต SQL-ััะปะพะฒะธะน (int, str, dict, list, set) |

---

### ๐ฆ QR API (Query Runtime)

ะัะพัััะต ะธ ะผะพัะฝัะต CRUD-ะพะฟะตัะฐัะธะธ ะฒ ะดััะต ORM-ะผะธะฝะธะผะฐะปะธะทะผะฐ:

| ะะตัะพะด | ะะฟะธัะฐะฝะธะต | ะะพะทะฒัะฐั |
|--------|-----------|---------|
| `qr()` | ะฃะฝะธะฒะตััะฐะปัะฝัะน SELECT/SHOW/EXPLAIN | ะกะฟะธัะพะบ dict-ัััะพะบ |
| `qr_rw()` | ะะพะปััะฐะตั ะพะดะฝั ะทะฐะฟะธัั | Dict |
| `qr_add()` | ะะพะฑะฐะฒะปัะตั ะทะฐะฟะธัั | Dict ะฒััะฐะฒะปะตะฝะฝะพะน ัััะพะบะธ |
| `qr_update()` | ะะฑะฝะพะฒะปัะตั ะทะฐะฟะธัั ะฟะพ WHERE | Dict ะพะฑะฝะพะฒะปัะฝะฝะพะน ัััะพะบะธ |
| `qr_delete()` | ะฃะดะฐะปัะตั ะทะฐะฟะธัั | Dict ัะดะฐะปัะฝะฝะพะน |
| `qr_foi()` | Find-Or-Insert | Dict |
| `qr_fou()` | Find-Or-Update | Dict |
| `qr_max()` | MAX(field) | scalar |

---

### ๐ Hash Utilities
- `mk_hash(*parts)` โ MD5 ะพั ัััะพะบะพะฒัั ัะฐััะตะน (ัะฝะธะฒะตััะฐะปัะฝัะน ะธะดะตะฝัะธัะธะบะฐัะพั).  
- `mk_row_hash(row, fields)` โ ััั ะพั ะฒัะฑัะฐะฝะฝัั ะฟะพะปะตะน ัััะพะบะธ (ะบะพะฝััะพะปั ะฒะตััะธะน ะธ ัะตะปะพััะฝะพััะธ).

---

## โ๏ธ ะะปะฐัั `TConfig` โ ัะฟัะฐะฒะปะตะฝะธะต ะพะบััะถะตะฝะธะตะผ ะธ ะบะพะฝัะธะณััะฐัะธะตะน

**ะะพะปั:** ัะธะฝััะพะฝะธะทะธััะตั ะฒะฝัััะตะฝะฝะธะน ENV ะธ ัะฐะฑะปะธัั `ZZ$CONFIG`.

| ะะตัะพะด | ะะฐะทะฝะฐัะตะฝะธะต |
|--------|-------------|
| `do_set(name, value, text, type_)` | ะะฐะฟะธััะฒะฐะตั ะทะฝะฐัะตะฝะธะต ะฒ ENV ะธ DB |
| `get(name, default)` | ะะพะทะฒัะฐัะฐะตั ะทะฝะฐัะตะฝะธะต ะธะปะธ ัะพะทะดะฐัั default |
| `set(name, value, text, type_)` | ะัะฑะปะธัะฝะพะต ะพะฑะฝะพะฒะปะตะฝะธะต ะฟะฐัะฐะผะตััะฐ |
| `get_int`, `get_float`, `get_bool` | ะขะธะฟะธะทะธัะพะฒะฐะฝะฝัะต ะณะตััะตัั |

๐ก ะัะฟะพะปัะทัะตั `qr_fou` ะดะปั ะณะฐัะฐะฝัะธัะพะฒะฐะฝะฝะพะน ะบะพะฝัะธััะตะฝัะฝะพััะธ (find-or-update).

---

## ๐งฌ ะะปะฐัั `TSchema` โ introspection ะฑะฐะทั

**ะะพะปั:** ะพะฟะธััะฒะฐะตั ััััะบัััั ัะฐะฑะปะธั ะธ ะบะพะฝััะฐะฝั.

ะญัะฐะฟ ัะตะฐะปะธะทะฐัะธะธ: **Stage 1 (PPS Doctrine).**

### ะัะฝะพะฒะฝัะต ะผะตัะพะดั:
- `do_open()` โ ะธะฝะธัะธะฐะปะธะทะฐัะธั ัะธะปัััะพะฒ (allow/deny-prefixes) ะธ ะทะฐะณััะทะบะฐ ัะฐะฑะปะธั.  
- `do_close()` โ ะพัะธััะบะฐ ััััะบัััั.  
- `_load_tables()` โ ะธะทะฒะปะตัะตะฝะธะต ัะฟะธัะบะฐ ัะฐะฑะปะธั ะธ ัะธะปัััะฐัะธั.  
- `_register_constants()` โ (stub) ะฐะฒัะพะณะตะฝะตัะฐัะธั ะบะพะฝััะฐะฝั ะฟะพ ััะตะผะฐะผ.

---

## ๐ Application lifecycle

### `Application()`
ะกะพะทะดะฐัั ัะบะทะตะผะฟะปัั `TApplication`, ะธะฝะธัะธะฐะปะธะทะธััะตั ะปะพะณะณะตั ะธ ัะตัััะต ัะดัะฐ:

```
TSession โ TDatabase โ TConfig โ TSchema
```

ะัะฒะพะดะธั ััะฐััั ะฟะพะดะบะปััะตะฝะธั ะธ ะณะพัะพะฒะฝะพััะธ.

### `CloseApplication()`
ะะฐะบััะฒะฐะตั ัะพะตะดะธะฝะตะฝะธั, ะพัะธัะฐะตั ะบะพะผะฟะพะฝะตะฝัั ะธ ะฒัะฒะพะดะธั:
> ๐ฌ The End โ HappyEnd edition ๐

---

## ๐ช ะคะฐัะฐะดะฝัะต ััะฝะบัะธะธ (Public API)

| ะคัะฝะบัะธั | ะะฐะทะฝะฐัะตะฝะธะต |
|----------|-------------|
| `qr()`, `qr_rw()` | ะฃะฝะธะฒะตััะฐะปัะฝัะน SELECT / FetchOne |
| `qr_add()`, `qr_update()`, `qr_delete()` | CRUD-ะพะฟะตัะฐัะธะธ |
| `qr_foi()`, `qr_fou()` | Find-Or-Insert / Find-Or-Update |
| `qr_max()` | ะะณัะตะณะฐัะธั (MAX) |
| `exec()` | ะัะฟะพะปะฝะตะฝะธะต ะฟัะพะธะทะฒะพะปัะฝะพะณะพ SQL |
| `mk_hash()`, `mk_row_hash()` | ะฅัั-ะฟะพะผะพัะฝะธะบะธ |
| `key()`, `set_key()` | ะะฐะฑะพัะฐ ั ะบะพะฝัะธะณััะฐัะธะตะน |
| `key_int()`, `key_float()`, `key_bool()` | ะขะธะฟะธะทะธัะพะฒะฐะฝะฝัะต ะพะฑัััะบะธ |

---

## ๐ ะััะธัะตะบัััะฝัะน ัะธะบะป QR

```
โโโโโโโโโโโโโโ
โ Applicationโ
โโโโโโโโฌโโโโโโ
       โผ
โโโโโโโโโโโโโโ
โ  TSession  โ  โ ะฟัะป ัะพะตะดะธะฝะตะฝะธะน, keep-alive
โโโโโโโโฌโโโโโโ
       โผ
โโโโโโโโโโโโโโ
โ TDatabase  โ  โ CRUD / QR / hash
โโโโโโโโฌโโโโโโ
       โผ
โโโโโโโโโโโโโโ
โ  TConfig   โ  โ ENV + ZZ$CONFIG
โโโโโโโโฌโโโโโโ
       โผ
โโโโโโโโโโโโโโ
โ  TSchema   โ  โ introspection
โโโโโโโโโโโโโโ
```

---

## โจ ะะปััะตะฒัะต ะฟัะตะธะผััะตััะฒะฐ

โ ะะฒัะพะผะฐัะธัะตัะบะฐั ะธะฝะธัะธะฐะปะธะทะฐัะธั ะฟัะธะปะพะถะตะฝะธั  
โ Connection Pooling + Keep-Alive  
โ ะฃะฝะธะฒะตััะฐะปัะฝัะน QR API  
โ ะะทะพะปััะธั ะพั SQL-ะธะฝัะตะบัะธะน  
โ ะะพะฝััะพะปั ัะตะปะพััะฝะพััะธ ัะตัะตะท ัััะธ  
โ ะฆะตะฝััะฐะปะธะทะพะฒะฐะฝะฝะฐั ะบะพะฝัะธะณััะฐัะธั  
โ ะะฐััะธััะตะผะฐั ััะตะผะฐ (Doctrine-style)  

---

## ๐งพ ะะตะทัะผะต

`bb_db.py` โ ััะพ **ัะตัะดัะต QR-ัะธััะตะผั**, ะพะฑัะตะดะธะฝัััะตะต ะฟะพะดะบะปััะตะฝะธะต, CRUD, ะบะพะฝัะธะณััะฐัะธั ะธ introspection ะฒ ะพะดะธะฝ ัะพะณะปะฐัะพะฒะฐะฝะฝัะน ะบะฐัะบะฐั.

> ๐ฌ *โQR โ ััะพ ะฝะต ะฟัะพััะพ Query Runtime. ะญัะพ Quick Reality โ ะฑััััะฐั ัะตะฐะปัะฝะพััั ะดะฐะฝะฝัั.โ*
